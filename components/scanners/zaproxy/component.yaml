name: zaproxy
description: "Runs zaproxy then parses findings into the OCSF format"
type: scanner
parameters:

  # auth scan variables
  - name: login_url
    type: string
    value: ""
  - name: username
    type: string
    value: ""
  - name: password
    type: string
    value: ""

  - name: target
    type: string
    value: ""

  # performance parameters
  - name: scan_duration_mins
    type: string
    value: "10"
  - name: spider_duration_mins
    type: string
    value: "5"
  - name: spider_max_crawl_depth
    type: string
    value: "5"
  - name: spider_max_children
    type: string
    value: "50"
    
  # internal params mostly used for dev
  - name: api_key
    type: string
    value: "changeme"
  - name: startup_check_retries
    type: string
    value: "10"
  - name: startup_check_interval
    type: string
    value: "10"
  - name: shutdown_timeout
    type: string
    value: "10"
steps:
  - name: write-metadata
    image: components/scanners/zaproxy/overwrite-metadata
    executable: /bin/app
    env_vars:
      TARGET: "{{ .parameters.target }}"
  - name: run-authenticated-zap-scan
    image: components/scanners/zaproxy/zap_authenticated_scan
    executable: /workdir/venv/bin/python3
    args:
    - /workdir/zap_authenticated_scan.py
    env_vars:
      TARGET: "{{ .parameters.target }}"
      # auth
      LOGIN_URL: "{{ .parameters.login_url }}"
      USERNAME: "{{ .parameters.username }}"
      PASSWORD: "{{ .parameters.password }}"

      # performance -- these overwhelm clusters
      SCAN_DURATION_MINS: "{{ .parameters.scan_duration_mins }}"
      SPIDER_DURATION_MINS: "{{ .parameters.spider_duration_mins }}"
      SPIDER_MAX_CRAWL_DEPTH: "{{ .parameters.spider_max_crawl_depth}}"
      SPIDER_MAX_CHILDREN: "{{ .parameters.spider_max_children}}"

      # smithy internal
      API_KEY: "{{ .parameters.api_key }}"
      REPORT_DIR: "{{ scratchWorkspace }}"
      REPORT_FILENAME: "zap-report.json"
      STARTUP_CHECK_RETRIES: "{{ .parameters.startup_check_retries }}"
      STARTUP_CHECK_INTERVAL: "{{ .parameters.startup_check_interval }}"
      SHUTDOWN_TIMEOUT: "{{ .parameters.shutdown_timeout }}"
  - name: parser
    image: components/scanners/zaproxy
    executable: /bin/app
    env_vars:
      ZAP_RAW_OUT_FILE_PATH: "{{ scratchWorkspace }}/zap-report.json"
